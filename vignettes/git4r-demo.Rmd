---
title: "git4r-demo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{git4r-demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## An introduction to using Git to change-control projects with R

Git is ideal for tracking changes between text-like files, such as code or
anything which can be opened in Notepad! Other 'binary' files (like .docx
or .jpeg) will be included too but a hidden copy will be saved every time it
is change (in `.git/`) which can get very bloated.
In this demo, we will create a temporary folder of 'code' and see how we can
use git to keep parallel versions, view, and restore history.

```
> library(git4r)
Using global (system default) config: johnhobbs <johnhobbs@myemail>
```
```
> myproject = tempfile(pattern = 'test-git-project-')
> dir.create(myproject)
> setwd(myproject)

> # Make some arbitary files for our repository
> for(my_code_files in LETTERS[1:5]) write(sample(letters,10), file=my_code_files)
```

### Selecting files and adding them to a commit

We can create a checkpoint (a *commit*) whenever we want which will save the
contents of any files we choose to add. We can then bring back this version of
the file any time in the future. Normally we would want to add all files to
our commit at once, but you might want to split the changes in two, for example
if you added something in one file, and an unrelated change in another. Try
adding only SOME of the file now with "2 4 5" or try all EXCEPT with "-1 -3"

You will be asked first whether to convert the normal directory to a git
repository -- always make sure you are in the right working directory so
you don't start git-tracking your entire home directory!

After you have added a couple of files, we will re-run git_add() and see that
we are given the option to remove any we regret. This time add ALL of them by
hitting enter. We will then commit all of these changes -- our first checkpoint
```
> git_add()
test-git-project directory is not inside a git repository - check this is the top level else ESCAPE and setwd()
Should this directory be turned into a git repo? (Y/N) Y

Copying default .gitignore to working directory
test-git-project is now a git repo 

Modified files to be added (+ created, - deleted, * changed since added, ? conflict) 
1    +  .gitignore
2    +  A
3    +  B
4    +  C
5    +  D
6    +  E
Which file numbers to add? (Hit ENTER to add all non-conflicting, else ESCAPE) 1 2 3 4

Adding 4 file(s)
```
```
> git_add()
Changes staged already 
1    +  .gitignore
2    +  A
3    +  B
4    +  C
Any file numbers to un-add? (Hit ENTER to keep all) 

Modified files to be added (+ created, - deleted, * changed since added, ? conflict) 
1    +  D
2    +  E
Which file numbers to add? (Hit ENTER to add all non-conflicting, else ESCAPE) 

Adding 2 file(s)
```
```
> git_commit()
Commit message: My first commit

Commit to master? (hit ESCAPE to cancel) 

Done
```


If we now make a whole bunch of changes, we will be able to see the new and
old version of each file, and our helpful commit message which should briefly
describe with one sentence what was changed and why. The 'who' and 'when' are
recorded automatically.
```
> for(even_more_files in LETTERS[4:7]) write(sample(1:10,5), file=even_more_files, append=TRUE)
```
```
> git_add()
Modified files to be added (+ created, - deleted, * changed since added, ? conflict) 
1       D
2       E
3    +  F
4    +  G
Which file numbers to add? (Hit ENTER to add all non-conflicting, else ESCAPE) 

Adding 4 file(s)
```
```
> git_commit()
Commit message: Add some more files and made some changes

Commit to master? (hit ESCAPE to cancel) 

Done
```

### Viewing historic commits

We can view the change history of a folder (such as '.' means everything) or
only changes which change a particular file. This gives us a an ID for this
commit which is a unique hash code, timestamp, and the message.
We can look at what has changed between each of these commits using git_diff()
on either a folder or a specific file. We can specify which commit we want to
compare using filters like 'before' or 'message', or use NULL to get the
the version right now.
```
> git_history()
  1 [facbb79] 2022-01-20: Add some more files and made some changes
  2 [d8759cf] 2022-01-20: My first commit
```
```
> git_diff(path='.', n=2, n=1)
```
<img style="max-width: 100%" src="git_diff_1.png" alt="git_diff(path='.', n=2, n=1)" />
```
> write('uncommitted change', 'F', append=TRUE)
```
```
> git_diff(path='F')
```
<img style="max-width: 100%" src="git_diff_2.png" alt="git_diff(path='F')" />


### Creating and changing branches

An important feature of git is keeping parallel versions of the same working
directory, for example if you want to test something out with the option of
changing back again. We do this by creating a 'branch' which will keep a
version of all our changes that we can swap between. Let's make a TEST change
and see that it disappears when we swap back to our master branch. We can
find out which branch we are currently on with git_branch() and seeing where
our current version 'HEAD' is.
```
> git_branch()
Current active branch:  master

New or existing branch name to move to (or hit ENTER to list branches) test-branch

```
```
> for(change_files in LETTERS[2:6]) write('TEST', file=change_files, append=TRUE)
```
```
> git_add()
Modified files to be added (+ created, - deleted, * changed since added, ? conflict) 
1       B
2       C
3       D
4       E
5       F
Which file numbers to add? (Hit ENTER to add all non-conflicting, else ESCAPE) 
```
```
> git_commit()
Commit message: Experimental changes on test-branch

Commit to test-branch? (hit ESCAPE to cancel) 

Done
```
```
> git_branch()
Current active branch:  test-branch

New or existing branch name to move to (or hit ENTER to list branches) 

[facbb7] (Local) master
[0f39df] (Local) (HEAD) test-branch
```


### Merging branches

We can merge these changes back into our master branch, or make another sub-
branch off this one. A common problem that comes up is if you are making
changes on lots of branches, you might change the same file in different ways.
This causes a 'conflict' which it will try to resolve automatically, but if
it cannot, it will highlight the code chunk with <<<<< >>>>>> and prompt you
to fix it by hand. You will not be allowed to git_commit() before you have
confirmed that you have fixed the conflicts and added the files by number.
When a merge is complete, all of the commits from both branches will make up
the history.
```
> git_branch()
Current active branch:  test-branch

New or existing branch name to move to (or hit ENTER to list branches) master
```
```
> write('This change will conflict with our test-branch', file='E')
```
```
> write('This change does not conflict with test-branch', file='H')
```
```
> git_add()
Modified files to be added (+ created, - deleted, * changed since added, ? conflict) 
1       E
2    +  H
Which file numbers to add? (Hit ENTER to add all non-conflicting, else ESCAPE) 

Adding 2 file(s)
```
```
> git_commit()
Commit message: Added a change to E and H which are not in test-branch

Commit to master? (hit ESCAPE to cancel) 

Done
```
```
git_diff('',branch='test-branch', branch='master')
```
<img style="max-width: 100%" src="git_diff_3.png" alt="git_diff('',branch='test-branch', branch='master')" />
```
> git_merge()
Branch to merge into master: test-branch

Merge test-branch into master 
Proceed? (Y/N) Y

Delete this branch after successful merge? (Y/N) Y

Merging test-branch into master
This merge will result with conflicts to resolve manually. Continue anyway? (Y/N) TRUE
The following files have conflicts:
	E
Deleting branch test-branch
Open the conflicting files and resolve <<<???>>> now? (Y/N) Y

```
```
> git_add()
Changes staged already 
1       B
2       C
3       D
4       F
Any file numbers to un-add? (Hit ENTER to keep all) 

Modified files to be added (+ created, - deleted, * changed since added, ? conflict) 
1    ?  E
Which file numbers to add? (Hit ENTER to add all non-conflicting, else ESCAPE) 1

Adding 1 file(s)
```
```
> git_commit()
Commit message: Completed the merge of our test code

Commit to master? (hit ESCAPE to cancel) 

Done
```
```
> git_history()
  1 [a92c7d2] 2022-01-20: Completed the merge of our test code
  2 [b9ea6f1] 2022-01-20: Added a change to E and H which are not in test-branch
  3 [0f39df6] 2022-01-20: Experimental changes on test-branch
  4 [facbb79] 2022-01-20: Add some more files and made some changes
  5 [d8759cf] 2022-01-20: My first commit
```


### Reverting back to a previous commit

Occasionally things will go wrong with our code and we will want to hard reset
or we merge / delete a branch by mistake. This is totally undo-able as long as
it is done as soon as possible.
git_undo() will show the recent history of actions that have happened locally,
and allow you to restore the files to a previous commit checkpoint. It does
not remember what branch you were on, so you must git_branch() back to the
appropriate - or new - branch if you had moved.
```
> file.remove('B', 'D', 'G')
[1] TRUE TRUE TRUE
```
```
> git_undo()

Not all changes have been committed! Run git_diff() to see what.

>>>>> Continuing will result in IRREVERSIBLE LOSS <<<<<

0  [a92c7d2] HEAD@{0}: commit (merge): Completed the merge of our test code
1  [b9ea6f1] HEAD@{1}: commit: Added a change to E and H which are not in test-branch
2  [facbb79] HEAD@{2}: checkout: moving from test-branch to master
3  [0f39df6] HEAD@{3}: commit: Experimental changes on test-branch
4  [facbb79] HEAD@{4}: checkout: moving from master to test-branch
5  [facbb79] HEAD@{5}: commit: Add some more files and made some changes
6  [d8759cf] HEAD@{6}: commit (initial): My first commit
Which commit to reset to? (Hit ESCAPE to cancel) 0

Selected: [a92c7d2] HEAD@{0}: commit (merge): Completed the merge of our test code
Confirm that you really want to change the working directory to historic state? (Y/N) Y

```
```
> list.files()
[1] "A" "B" "C" "D" "E" "F" "G" "H"
```


## Setting up a remote copy on a shared drive

Git repositories can be synchronised with a shared location to allow multiple
people to make versions (branches) and commit changes.

In your team, choose a shared drive which has the access level you need, and
make a directory. Use this as the `GIT_DEFAULT_REMOTE` by adding this to your
.Renviron file (see `?git_remote` for example).

Set up a pretend default_remote folder
```
> demo_default_remote = tempfile(pattern = 'test-default-remote-')
> dir.create(demo_default_remote)
> Sys.setenv(GIT_DEFAULT_REMOTE = demo_default_remote)
```

### Adding a new remote

Repositories can be given a 'remote' copy which allows changes to pushed to it
and then others can then download ('pull') these changes to their own local
version. This remote is often an http server such as GitHub however this may
not be reachable using a corporate system or not wanted.
This package encourages a simple shared drive folder to keep copies of the
team's code which then can be shared and kept in sync.
A repository should always have a remote path called 'origin' which it will
look at for changes every time git_pull() is called.
```
> git_remote()
Path to repo to modify remotes? (Hit ENTER for current repo) 

Listing remotes for the remote / repo "."
No remote yet!
Add remote? Specify with name='/path/or/url' or hit ENTER to add default origin or ESCAPE 

Now run git_push() to complete setup of remote branches
Creating bare repo at /tmp/test-default-remote/test-git-project
Adding origin at /tmp/test-default-remote/test-git-project
```
```
> git_push()
Current branch is not yet pushed to origin -- do this manually
Available remotes
1    origin  /tmp/test-default-remote/test-git-project
Index number of remote to push to: 1

Local branches to push (+ if not in remote, > current branch) 
1    +  >  master
Which branch numbers to push? (Hit ENTER to add all except + else ESCAPE) 1

Done
```
```
> git_pull()
Pull result: Already up-to-date
```

### Pushing changes to remote

After making commits to a branch, this branch should be pushed to the remote.
A branch can be kept local (private) by not pushing this branch. It is bad
practice to commit to 'master' branch because this will almost certainly give
problems where two people change the same file. Best is to create a unique
(and helpful) named branch and a nominated 'codebase owner' does a merge into
master branch for everyone once it is approved. (This is often called a merge
request or pull-request and can be strictly enforced on http remotes).
The cycle of pull-add-commit-push has been wrapped up in a simple git() call.
```
> git_branch()
Current active branch:  master

New or existing branch name to move to (or hit ENTER to list branches) dev-branch
```
```
write('Change by person A', file='F', append=TRUE)
```
```
> git()
Skipping pull: active branch has not been pushed to origin remote
Modified files to be added (+ created, - deleted, * changed since added, ? conflict) 
1       F
Which file numbers to add? (Hit ENTER to add all non-conflicting, else ESCAPE) 

Adding 1 file(s)
Commit message: Made a change on the dev-branch, waiting approval

Commit to dev-branch? (hit ESCAPE to cancel) 

Done
Current branch is not yet pushed to origin -- do this manually
Available remotes
1    origin  /tmp/test-default-remote/test-git-project
Index number of remote to push to: 1

Local branches to push (+ if not in remote, > current branch) 
1    +  >  dev-branch
2          master
Which branch numbers to push? (Hit ENTER to add all except + else ESCAPE) 1 2

Done
```


### Cloning another copy from the shared remote

Sharing code is made simple by cloning the remote folder to make a local copy.
This automatically sets the same remote as 'origin' which means all changes
other people make are pushed and pulled to the same place, keeping everyone
in sync. Here, the GIT_DEFAULT_REMOTE folder is used to list all subfolders
which can be cloned from, or you can give another path or http address.
Changing to a remote branch will download a local copy.

If two people do push different commits onto the same branch, when you next
pull (download changes) it will give conflicts like a merge and git_add()
should be used to find and fix the conflicting files.
```
> git_clone()
Available repo names: 
test-git-project
```
```
> another_tempdir = tempfile()
> dir.create(another_tempdir)
> git_clone('test-git-project', to=another_tempdir)
Cloning  test-git-project  into " /tmp/another_tempdir/test-git-project "
 -- proceed? (Y/N) Y

Cloning to /tmp/another_tempdir/test-git-project
Set working directory to here? (Y/N) Y

> git_branch()
Current active branch:  master

New or existing branch name to move to (or hit ENTER to list branches) 

[a92c7d] (Local) (HEAD) master
[66d1db] (origin @ /tmp/test-default-remote/test-git-project) dev-branch
(origin @ /tmp/test-default-remote/test-git-project) HEAD
[a92c7d] (origin @ /tmp/test-default-remote/test-git-project) master
New or existing branch name to move to (or hit ENTER to cancel) 
```
```
git_diff('F', branch='master', branch='origin/dev-branch')
```
<img style="max-width: 100%" src="git_diff_4.png" alt="git_diff('F', branch='master', branch='origin/dev-branch')" />
```
> git_merge()
Branch to merge into master: origin/dev-branch

Merge origin/dev-branch into master 
Proceed? (Y/N) Y

Delete this branch after successful merge? (Y/N) N

Merging origin/dev-branch into master
```

